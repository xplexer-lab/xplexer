# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: Unit Tests

env:
  REPORT_JUNIT: .tmp/reports/test-ci.junit.xml
  REPORT_GOLANG_JSON: .tmp/reports/test-ci.go.json
  COVERAGE_PROFILE: .tmp/reports/coverage.out
  COVERAGE_HTML: .tmp/reports/coverage.html

on:
  push:
    branches:
      - master
      - task/**

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25"

      - name: Install dependencies
        run: make deps

      - name: Run Unit Tests
        run: |
          mkdir -p $(dirname ${{ env.REPORT_JUNIT }})
          gotestsum \
            -f github-actions \
            --jsonfile=${{ env.REPORT_GOLANG_JSON }} \
            --junitfile=${{ env.REPORT_JUNIT }} \
            -covermode=atomic \
            -coverprofile=${{ env.COVERAGE_PROFILE }} \
            ./...

      - name: Generate Coverage HTML Report
        run: go tool cover -html=${{ env.COVERAGE_PROFILE }} -o ${{ env.COVERAGE_HTML }}

      - name: Coverage Summary
        run: |
          echo "## ðŸ›¡ï¸ Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TOTAL_COVERAGE=$(go tool cover -func=${{ env.COVERAGE_PROFILE }} | grep total | awk '{print $3}')
          echo "**Total Coverage: $TOTAL_COVERAGE**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Details" >> $GITHUB_STEP_SUMMARY
          echo '```text' >> $GITHUB_STEP_SUMMARY
          go tool cover -func=${{ env.COVERAGE_PROFILE }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Coverage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ${{ env.COVERAGE_HTML }}

      - name: Test Report
        uses: dorny/test-reporter@v2
        if: ${{ !cancelled() }}
        with:
          name: Go Tests
          path: ${{ env.REPORT_GOLANG_JSON }}
          reporter: golang-json
